#!/usr/bin/env bash

declare -a dicevar=(
  "LVFAILURE"
  "HYPOVOLEMIA"
  "ANAPHYLAXIS"
  "ERRLOWOUTPUT"
  "ERRCAUTER"
  "INSUFFANESTH"
  "FIO2"
  "PULMEMBOLUS"
  "INTUBATION"
  "DISCONNECT"
  "MINVOLSET"
  "KINKEDTUBE"
)

# generate
mkdir -p tmp
for out in "${dicevar[@]}"; do
  if [ ! -f tmp/"$out.dice.out" ]; then
    cat ./main.dice-partial > tmp/"$out".dice
    echo "$out" >> tmp/"$out.dice"
    echo "$out" > tmp/"$out.dice.out"
    dice "tmp/$out.dice" | tee -a "tmp/$out.dice.out"
  fi
done

# aggregate
echo "# DO NOT MODIFY! this is autogenerated from truth.sh!" > "tmp/truth.py"
(for out in "${dicevar[@]}"; do
    echo -n "$out = "
    awk 'BEGIN{
     row=""
     i=0
    }
    /^[0-9]+\s+[0-9.]+\s*$/{
      if (i == 0) {
        row = row "[" $2
      } else {
        row = row "," $2
      }
      i ++
    }
    END { print row "]" }' "tmp/$out.dice.out"
 done) | tee -a "tmp/truth.py"


echo "from collections import OrderedDict"      >> "tmp/truth.py"
echo "truthdict = OrderedDict(["                >> "tmp/truth.py"
(for out in "${dicevar[@]}"; do
  echo "  (\"$out\", $out),"                    >> "tmp/truth.py"
done)
echo "])"                                       >> "tmp/truth.py"
echo "truth = [sum([i * p for i, p in enumerate(ps)]) for k, ps in truthdict.items()]" >> "tmp/truth.py"
